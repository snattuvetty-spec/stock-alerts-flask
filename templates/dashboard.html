{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="page-title">
    ğŸ“Š Dashboard
    <small style="font-size:14px;font-weight:400;color:#6b7280;margin-left:8px;">
        Auto-refreshes every 2 min
    </small>
</div>

<!-- Setup Banner for New Users -->
{% if needs_setup %}
<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(102,126,234,0.3);">
    <h3 style="margin:0 0 8px 0;font-size:18px;">ğŸ‘‹ Welcome! Let's get you set up</h3>
    <p style="margin:0 0 16px 0;opacity:0.95;font-size:14px;">
        To receive stock alerts on Telegram, you need to complete a quick one-time setup:
    </p>
    <ol style="margin:0 0 16px 0;padding-left:20px;font-size:14px;line-height:1.8;">
        <li>Open Telegram and search for <strong>@userinfobot</strong></li>
        <li>Send any message to get your Chat ID</li>
        <li>Come back and add it in Settings below</li>
    </ol>
    <a href="/settings" style="display:inline-block;background:white;color:#667eea;padding:10px 20px;border-radius:8px;text-decoration:none;font-weight:600;font-size:14px;">
        âš™ï¸ Go to Settings
    </a>
</div>
{% endif %}

<!-- Status bar -->
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;align-items:center;">
    {% if not premium %}
        {% if days_left > 0 %}
        <span style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;">
            ğŸ Free Trial â€” {{ days_left }} days left
        </span>
        {% endif %}
        <a href="/settings" style="background:#f39c12;color:white;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;text-decoration:none;">
            â­ Upgrade to Premium
        </a>
    {% else %}
        <span style="background:#27ae60;color:white;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;">
            â­ Premium Active
        </span>
    {% endif %}
    <span style="background:#e8f4f8;color:#2E86AB;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;">
        ğŸ“Š {{ alert_count }}/{{ alert_limit }} Alerts
    </span>
</div>

{% if not alerts %}
<div class="card">
    <div class="card-body" style="text-align:center;padding:48px 20px;">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ“­</div>
        <h3 style="color:#6b7280;margin-bottom:8px;">No alerts yet</h3>
        <p style="color:#9ca3af;margin-bottom:20px;">Add your first stock alert to get started</p>
        <a href="/add" class="btn btn-primary">â• Add First Alert</a>
    </div>
</div>
{% else %}

<div class="card">
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>ğŸ“ˆ Symbol</th>
                    <th>ğŸ“Š 3M Chart</th>
                    <th>ğŸ’° Price</th>
                    <th>ğŸ¯ Target</th>
                    <th>ğŸ“Š Type</th>
                    <th>ğŸ”” Status</th>
                    <th>ğŸ“° News</th>
                    <th>âš™ï¸ Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for a in alerts %}
                <tr id="row-{{ a.id }}">
                    <td class="symbol">{{ a.symbol }}</td>
                    <td style="padding:8px;text-align:center;">
                        {% if a.sparkline and a.sparkline|length > 1 %}
                        <a href="{{ a.chart_url }}" target="_blank" title="Click for detailed chart on Yahoo Finance">
                            <canvas id="spark-{{ a.id }}" width="80" height="25" style="cursor:pointer;display:block;"></canvas>
                        </a>
                        <script>
                        (function() {
                            const canvas = document.getElementById('spark-{{ a.id }}');
                            const ctx = canvas.getContext('2d');
                            const data = {{ a.sparkline|tojson }};
                            
                            if (data && data.length > 1) {
                                const min = Math.min(...data);
                                const max = Math.max(...data);
                                const range = max - min || 1;
                                const width = canvas.width;
                                const height = canvas.height;
                                const step = width / (data.length - 1);
                                
                                // Determine color based on trend
                                const color = data[data.length-1] >= data[0] ? '#27ae60' : '#e74c3c';
                                
                                // Draw line
                                ctx.strokeStyle = color;
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                
                                data.forEach((price, i) => {
                                    const x = i * step;
                                    const y = height - ((price - min) / range) * (height - 4) - 2;
                                    if (i === 0) ctx.moveTo(x, y);
                                    else ctx.lineTo(x, y);
                                });
                                
                                ctx.stroke();
                            }
                        })();
                        </script>
                        {% else %}
                        <a href="{{ a.chart_url }}" target="_blank" class="btn btn-outline btn-sm" style="font-size:11px;padding:4px 8px;">
                            ğŸ“Š Chart
                        </a>
                        {% endif %}
                    </td>
                    <td>
                        <span class="price">{{ a.price }}</span><br>
                        <span class="{{ 'change-up' if a.change_up else 'change-dn' }}">
                            {{ a.change_pct }}
                        </span>
                    </td>
                    <td class="price editable" 
                        data-alert-id="{{ a.id }}" 
                        data-field="target" 
                        data-value="{{ a.target }}"
                        title="Double-click to edit"
                        style="cursor:pointer;">
                        ${{ "%.2f"|format(a.target) }}
                    </td>
                    <td class="editable" 
                        data-alert-id="{{ a.id }}" 
                        data-field="type" 
                        data-value="{{ a.type }}"
                        title="Double-click to toggle"
                        style="cursor:pointer;">
                        <span class="badge {{ 'badge-above' if a.type == 'above' else 'badge-below' }}">
                            {{ 'ğŸ”¼ ABOVE' if a.type == 'above' else 'ğŸ”½ BELOW' }}
                        </span>
                    </td>
                    <td>
                        {% if a.status == 'triggered' %}
                        <span class="status-triggered">ğŸš€ TRIGGERED!</span>
                        {% else %}
                        <span class="status-waiting">â³ Waiting</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ a.news_url }}" target="_blank" class="btn btn-outline btn-sm">ğŸ“°</a>
                    </td>
                    <td style="white-space:nowrap;">
                        <a href="/edit/{{ a.id }}" class="btn btn-primary btn-sm">âœï¸ Edit</a>
                        <button onclick="confirmDelete('{{ a.id }}', '{{ a.symbol }}')"
                                class="btn btn-danger btn-sm">ğŸ—‘ï¸ Del</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<footer style="margin-top:24px;padding:16px 0;border:none;text-align:center;font-size:12px;color:#9ca3af;">
    âš ï¸ Stock Alerts Pro provides price notifications only. This is NOT financial advice.<br>
    Natts Digital is not an AFS licensee. Always consult a licensed financial advisor before making investment decisions.
</footer>
{% endblock %}

{% block scripts %}
<script>
    // Auto refresh every 2 minutes
    setTimeout(() => window.location.reload(), 120000);
    
    // Inline editing for target and type
    document.querySelectorAll('.editable').forEach(cell => {
        cell.addEventListener('dblclick', function() {
            const alertId = this.dataset.alertId;
            const field = this.dataset.field;
            const currentValue = this.dataset.value;
            
            if (field === 'target') {
                // Edit target price
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.01';
                input.value = currentValue;
                input.style.width = '100px';
                input.style.padding = '4px 8px';
                input.style.fontSize = '14px';
                input.style.border = '2px solid #2E86AB';
                input.style.borderRadius = '4px';
                
                const originalContent = this.innerHTML;
                this.innerHTML = '';
                this.appendChild(input);
                input.focus();
                input.select();
                
                const save = async () => {
                    const newValue = parseFloat(input.value);
                    if (newValue && newValue > 0) {
                        const response = await fetch(`/api/update_alert/${alertId}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({target: newValue})
                        });
                        if (response.ok) {
                            this.innerHTML = '$' + newValue.toFixed(2);
                            this.dataset.value = newValue;
                        } else {
                            alert('Update failed!');
                            this.innerHTML = originalContent;
                        }
                    } else {
                        this.innerHTML = originalContent;
                    }
                };
                
                input.addEventListener('blur', save);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') save();
                    if (e.key === 'Escape') this.innerHTML = originalContent;
                });
                
            } else if (field === 'type') {
                // Toggle type above/below
                const newType = currentValue === 'above' ? 'below' : 'above';
                
                fetch(`/api/update_alert/${alertId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type: newType})
                }).then(response => {
                    if (response.ok) {
                        // Update display
                        const badge = this.querySelector('.badge');
                        if (newType === 'above') {
                            badge.className = 'badge badge-above';
                            badge.textContent = 'ğŸ”¼ ABOVE';
                        } else {
                            badge.className = 'badge badge-below';
                            badge.textContent = 'ğŸ”½ BELOW';
                        }
                        this.dataset.value = newType;
                    } else {
                        alert('Update failed!');
                    }
                });
            }
        });
    });
</script>
{% endblock %}
