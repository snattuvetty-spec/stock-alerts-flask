{% extends "base.html" %}
{% block title %}Add Alert{% endblock %}
{% block content %}
<div class="page-title">‚ûï Add New Alert</div>

<div style="max-width:600px;">
<div class="card">
<div class="card-body">
    {% if error %}<div class="alert alert-error">‚ùå {{ error }}</div>{% endif %}
    
    <!-- Step 1: Search for stock -->
    <div id="search-step">
        <div class="form-group">
            <label>Stock Symbol</label>
            <input type="text" id="symbolSearch" placeholder="e.g. AAPL, HAL, CBA, BHP"
                   style="text-transform:uppercase;">
            <div class="input-hint">
                Enter the stock ticker symbol. We'll search both US (NASDAQ/NYSE) and Australian (ASX) markets and show you the full company name.
            </div>
        </div>
        <button onclick="searchStock()" class="btn btn-primary" id="searchBtn">
            üîç Search Stock
        </button>
        
        <div id="searchResults" style="margin-top:20px;display:none;"></div>
    </div>
    
    <!-- Step 2: Create alert (hidden until stock selected) -->
    <form method="POST" id="alertForm" style="display:none;">
        <input type="hidden" name="symbol" id="selectedSymbol">
        
        <div style="background:#e8f4f8;padding:16px;border-radius:8px;margin-bottom:20px;">
            <div style="font-size:18px;font-weight:700;color:#2E86AB;" id="selectedStockName"></div>
            <div style="font-size:13px;color:#6b7280;margin-top:4px;" id="selectedStockInfo"></div>
        </div>
        
        <div class="form-group">
            <label>Target Price ($)</label>
            <input type="number" name="target" step="0.01" min="0.01" placeholder="0.00" required>
        </div>
        <div class="form-group">
            <label>Alert When Price Goes</label>
            <select name="alert_type">
                <option value="above">üîº Above target</option>
                <option value="below">üîΩ Below target</option>
            </select>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;">
            <button type="button" onclick="resetForm()" class="btn btn-outline" style="flex:1;">
                ‚Üê Change Stock
            </button>
            <button type="submit" class="btn btn-primary" style="flex:2;">‚úÖ Create Alert</button>
        </div>
    </form>
</div>
</div>
</div>

<script>
let searchTimer;

document.getElementById('symbolSearch').addEventListener('input', function() {
    clearTimeout(searchTimer);
    const sym = this.value.toUpperCase().trim();
    if (sym.length >= 1) {
        searchTimer = setTimeout(() => searchStock(), 800);
    }
});

document.getElementById('symbolSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchStock();
    }
});

async function searchStock() {
    const sym = document.getElementById('symbolSearch').value.toUpperCase().trim();
    if (!sym) return;
    
    const btn = document.getElementById('searchBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Searching...';
    
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.style.display = 'none';
    
    try {
        const response = await fetch(`/price/${sym}`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
            let html = '<h4 style="margin-bottom:12px;font-size:16px;">Select your stock:</h4>';
            
            data.results.forEach(stock => {
                const priceStr = stock.currency + ' $' + stock.price.toFixed(2);
                // If name is same as symbol, show "Stock information" instead
                const displayName = stock.name === stock.symbol ? 'Company information unavailable' : stock.name;
                
                html += `
                <div onclick="selectStock('${stock.symbol}', '${stock.name}', '${stock.exchange}', ${stock.price}, '${stock.currency}')"
                     style="background:white;border:2px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:12px;cursor:pointer;transition:all 0.15s;"
                     onmouseover="this.style.borderColor='#2E86AB';this.style.backgroundColor='#f8fbfd'"
                     onmouseout="this.style.borderColor='#e5e7eb';this.style.backgroundColor='white'">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div style="flex:1;">
                            <div style="font-size:18px;font-weight:700;color:#2E86AB;margin-bottom:6px;">${stock.symbol}</div>
                            <div style="font-size:14px;color:${displayName === 'Company information unavailable' ? '#9ca3af' : '#1a1a2e'};font-weight:${displayName === 'Company information unavailable' ? '400' : '500'};margin-bottom:4px;font-style:${displayName === 'Company information unavailable' ? 'italic' : 'normal'};">${displayName}</div>
                            <div style="font-size:12px;color:#6b7280;">
                                ${stock.exchange} ‚Ä¢ ${stock.market} Market
                            </div>
                        </div>
                        <div style="text-align:right;margin-left:16px;">
                            <div style="font-size:18px;font-weight:700;color:#27ae60;">${priceStr}</div>
                            <div style="font-size:11px;color:#9ca3af;margin-top:2px;">Current Price</div>
                        </div>
                    </div>
                </div>`;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.innerHTML = `
            <div class="alert alert-error">
                ‚ùå No stock found for "${sym}"<br>
                Please check the symbol and try again.
            </div>`;
            resultsDiv.style.display = 'block';
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div class="alert alert-error">‚ùå Search failed. Please try again.</div>';
        resultsDiv.style.display = 'block';
    }
    
    btn.disabled = false;
    btn.textContent = 'üîç Search Stock';
}

function selectStock(symbol, name, exchange, price, currency) {
    document.getElementById('selectedSymbol').value = symbol;
    document.getElementById('selectedStockName').textContent = `${symbol} - ${name}`;
    document.getElementById('selectedStockInfo').textContent = `${exchange} ‚Ä¢ Current Price: ${currency} $${price.toFixed(2)}`;
    
    document.getElementById('search-step').style.display = 'none';
    document.getElementById('alertForm').style.display = 'block';
}

function resetForm() {
    document.getElementById('search-step').style.display = 'block';
    document.getElementById('alertForm').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('symbolSearch').value = '';
    document.getElementById('symbolSearch').focus();
}
</script>
{% endblock %}
